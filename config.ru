require 'bundler/setup'
require 'sinatra/base'
require 'rack-rewrite'

# The project root directory
$root = ::File.dirname(__FILE__)

use Rack::Rewrite do
  r301 %r{.*}, 'http://www.samhamilton.co.uk$&', :if => Proc.new {|rack_env|
    rack_env['SERVER_NAME'] == 'samhamilton.co.uk'
  }
  r301 %r{^/2007/01/06/my-first-apple-a-macbook-pro/?$}, '/blog/2007/01/07/my-first-apple-a-macbook-pro/'
  r301 %r{^/2007/01/30/change-in-currency-laws/?$}, '/blog/2007/01/30/change-in-currency-laws/'
  r301 %r{^/2007/06/10/omg-file-type-for-os-x/?$}, '/blog/2007/06/11/omg-file-type-for-os-x/'
  r301 %r{^/2007/06/10/trackbacks/?$}, '/blog/2007/06/10/trackbacks/'
  r301 %r{^/2007/06/11/china-sensors-flickr/?$}, '/blog/2007/06/11/china-sensors-flickr/'
  r301 %r{^/2007/07/01/ebay-and-vero/?$}, '/blog/2007/07/01/ebay-and-vero/'
  r301 %r{^/2007/09/19/ofbiz-postgresql-and-a-worldwide-audience/?$}, '/blog/2007/09/19/ofbiz-postgresql-and-a-worldwide-audience/'
  r301 %r{^/2007/09/24/online-backup/?$}, '/blog/2007/09/24/online-backup/'
  r301 %r{^/2007/10/02/channeladvisor-buy-marketworks/?$}, '/blog/2007/10/02/channeladvisor-buy-marketworks/'
  r301 %r{^/2007/10/02/getting-redhat-virtualization-up-and-running/?$}, '/blog/2007/10/02/getting-redhat-virtualization-up-and-running/'
  r301 %r{^/2007/10/02/keeping-your-rhel5-xen-guest-systems-up2date/?$}, '/blog/2007/10/02/keeping-your-rhel5-xen-guest-systems-up2date/'
  r301 %r{^/2007/10/02/wordpress-23-upgrade/?$}, '/blog/2007/10/02/wordpress-23-upgrade/'
  r301 %r{^/2007/10/13/best-mac-tool-ever/?$}, '/blog/2007/10/14/best-mac-tool-ever/'
  r301 %r{^/2007/10/23/distributed-it-network-backups/?$}, '/blog/2007/10/24/distributed-it-network-backups/'
  r301 %r{^/2008/08/09/mac-svn-clients/?$}, '/blog/2008/08/10/mac-svn-clients/'
  r301 %r{^/2008/08/24/how-a-year-in-china-changes-everything/?$}, '/blog/2008/08/25/how-a-year-in-china-changes-everything/'
  r301 %r{^/2008/09/21/company-hires-101-person/?$}, '/blog/2008/09/21/company-hires-101-person/'
  r301 %r{^/2008/10/13/the-world-blows-up-banking-madness/?$}, '/blog/2008/10/14/the-world-blows-up-banking-madness/'
  r301 %r{^/2008/12/08/landmark/?$}, '/blog/2008/12/08/landmark/'
  r301 %r{^/2008/12/28/live-website/?$}, '/blog/2008/12/28/live-website/'
  r301 %r{^/2009/01/09/goals-for-2009/?$}, '/blog/2009/01/10/goals-for-2009/'
  r301 %r{^/2009/01/25/directory-submitting-software/?$}, '/blog/2009/01/26/directory-submitting-software/'
  r301 %r{^/2009/02/05/mac?$}, '/blog/2009/02/05/mac-os-x-101-or-later-how-to-connect-to-windows-file-sharing-smb/'
  r301 %r{^/2009/02/05/mac-os-x-101-or-later-how-to-connect-to-windows-file-sharing-smb/?$}, '/blog/2009/02/05/mac-os-x-101-or-later-how-to-connect-to-windows-file-sharing-smb/'
  r301 %r{^/2009/02/22/whats-a-cooking/?$}, '/blog/2009/02/23/whats-a-cooking/'
  r301 %r{^/2009/02/28/search-engines-and-their-twitter-accounts/?$}, '/blog/2009/02/28/search-engines-and-their-twitter-accounts/'
  r301 %r{^/2009/03/04/usb-on-a-dvd-player/?$}, '/blog/2009/03/04/usb-on-a-dvd-player/'
  r301 %r{^/2009/03/08/dinner-at-osteria/?$}, '/blog/2009/03/08/dinner-at-osteria/'
  r301 %r{^/2009/03/09/the-t-mobile-dance-best-of-british/?$}, '/blog/2009/03/10/the-t-mobile-dance-best-of-british/'
  r301 %r{^/2009/03/11/add-a-google-news-widget/?$}, '/blog/2009/03/11/add-a-google-news-widget/'
  r301 %r{^/2009/03/11/how-to-open-all-office-apps-in-05-seconds/?$}, '/blog/2009/03/12/how-to-open-all-office-apps-in-05-seconds/'
  r301 %r{^/2009/03/19/f1-rule-change-again/?$}, '/blog/2009/03/19/f1-rule-change-again/'
  r301 %r{^/2009/03/19/ibmsun-merger/?$}, '/blog/2009/03/19/ibmsun-merger/'
  r301 %r{^/2009/03/19/new-iphone-software/?$}, '/blog/2009/03/19/new-iphone-software/'
  r301 %r{^/2009/03/29/my-top-free-magento-plugins/?$}, '/blog/2009/03/29/my-top-free-magento-plugins/'
  r301 %r{^/2009/04/01/a-rather-crap-earth-hour-in-shanghai/?$}, '/blog/2009/04/01/a-rather-crap-earth-hour-in-shanghai/'
  r301 %r{^/2009/04/05/can-f1-get-any-more-screwed-up/?$}, '/blog/2009/04/05/can-f1-get-any-more-screwed-up/'
  r301 %r{^/2009/04/05/loving-this-movie-poster/?$}, '/blog/2009/04/05/loving-this-movie-poster/'
  r301 %r{^/2009/04/05/slingbox-coming-to-an-iphone-near-you/?$}, '/blog/2009/04/05/slingbox-coming-to-an-iphone-near-you/'
  r301 %r{^/2009/04/05/want-to-see-the-secret-google-server/?$}, '/blog/2009/04/05/want-to-see-the-secret-google-server/'
  r301 %r{^/2009/04/05/why-did-internet-traffic-in-sweden-fall-by-33/?$}, '/blog/2009/04/05/why-did-internet-traffic-in-sweden-fall-by-33/'
  r301 %r{^/2009/04/06/another-mental-f1-race-this-time-in-malaysia/?$}, '/blog/2009/04/06/another-mental-f1-race-this-time-in-malaysia/'
  r301 %r{^/2009/04/17/build-up-to-shanghai-f1/?$}, '/blog/2009/04/17/build-up-to-shanghai-f1/'
  r301 %r{^/2009/04/17/ebay-checkout-changes-and-free-pp/?$}, '/blog/2009/04/17/ebay-checkout-changes-and-free-pp/'
  r301 %r{^/2009/04/18/f1-saturday/?$}, '/blog/2009/04/19/f1-saturday/'
  r301 %r{^/2009/04/20/wicked-but-wet-f1-in-shangai/?$}, '/blog/2009/04/20/wicked-but-wet-f1-in-shangai/'
  r301 %r{^/2009/04/21/ofbiz-release-branch-release904/?$}, '/blog/2009/04/21/ofbiz-release-branch-release904/'
  r301 %r{^/2009/04/24/f1-news-roundup/?$}, '/blog/2009/04/24/f1-news-roundup/'
  r301 %r{^/2009/04/24/pirate-bay/?$}, '/blog/2009/04/24/pirate-bay/'
  r301 %r{^/2009/04/27/f1-news-round-up/?$}, '/blog/2009/04/27/f1-news-round-up/'
  r301 %r{^/2009/05/03/how?$}, '/blog/2009/05/04/how-to-upgrade-magento-using-magento-connect-manager/'
  r301 %r{^/2009/05/03/how-to-upgrade?$}, '/blog/2009/05/04/how-to-upgrade-magento-using-magento-connect-manager/'
  r301 %r{^/2009/05/03/how-to-upgrade-magento?$}, '/blog/2009/05/04/how-to-upgrade-magento-using-magento-connect-manager/'
  r301 %r{^/2009/05/03/how-to-upgrade-magento-using-magento-connect-manager/?$}, '/blog/2009/05/04/how-to-upgrade-magento-using-magento-connect-manager/'
  r301 %r{^/2009/05/11/gone-to-thailand/?$}, '/blog/2009/05/12/gone-to-thailand/'
  r301 %r{^/2009/05/21/fedora-11/?$}, '/blog/2009/05/21/fedora-11/'
  r301 %r{^/2009/05/22/f1-the-world-gone-mad/?$}, '/blog/2009/05/23/f1-the-world-gone-mad/'
  r301 %r{^/2009/05/22/is-the-uk-going-down-the-pan/?$}, '/blog/2009/05/23/is-the-uk-going-down-the-pan/'
  r301 %r{^/2009/05/22/required-reading/?$}, '/blog/2009/05/23/required-reading/'
  r301 %r{^/2009/05/22/to-mysql-or-not/?$}, '/blog/2009/05/23/to-mysql-or-not/'
  r301 %r{^/2009/05/24/f1-update-before-the-race-starts/?$}, '/blog/2009/05/25/f1-update-before-the-race-starts/'
  r301 %r{^/2009/05/24/how-to-increase-the-max-upload-size-in-php-using-htaccess/?$}, '/blog/2009/05/24/how-to-increase-the-max-upload-size-in-php-using-htaccess/'
  r301 %r{^/2009/05/24/twitter-weekly-updates/?$}, '/blog/2009/05/24/twitter-weekly-updates/'
  r301 %r{^/2009/05/31/twitter-weekly-updates-2/?$}, '/blog/2009/05/31/twitter-weekly-updates-2/'
  r301 %r{^/2009/06/04/is-this-thing-really-going-to-work/?$}, '/blog/2009/06/04/is-this-thing-really-going-to-work/'
  r301 %r{^/2009/06/07/twitter-weekly-updates-3/?$}, '/blog/2009/06/07/twitter-weekly-updates-3/'
  r301 %r{^/2009/06/14/twitter-weekly-updates-4/?$}, '/blog/2009/06/14/twitter-weekly-updates-4/'
  r301 %r{^/2009/06/21/twitter-weekly-updates-5/?$}, '/blog/2009/06/21/twitter-weekly-updates-5/'
  r301 %r{^/2009/06/28/weekly-seo-round-up/?$}, '/blog/2009/06/29/weekly-seo-round-up/'
  r301 %r{^/2009/07/06/weekly-seo-round-up-2/?$}, '/blog/2009/07/07/weekly-seo-round-up-2/'
  r301 %r{^/2009/07/13/weekly-seo-round-up-3/?$}, '/blog/2009/07/14/weekly-seo-round-up-3/'
  r301 %r{^/2009/07/20/weekly-seo-round-up-4/?$}, '/blog/2009/07/21/weekly-seo-round-up-4/'
  r301 %r{^/2009/07/27/weekly-seo-round-up-5/?$}, '/blog/2009/07/28/weekly-seo-round-up-5/'
  r301 %r{^/2009/08/03/seo-weekly-round-up/?$}, '/blog/2009/08/04/seo-weekly-round-up/'
  r301 %r{^/2009/08/10/seo-weekly-round-up-2/?$}, '/blog/2009/08/11/seo-weekly-round-up-2/'
  r301 %r{^/2009/08/11/how-to-speed-up-your-site/?$}, '/blog/2009/08/12/how-to-speed-up-your-site/'
  r301 %r{^/2009/08/14/secret-to-good-customer-service/?$}, '/blog/2009/08/15/secret-to-good-customer-service/'
  r301 %r{^/2009/08/17/seo-weekly-round-up-3/?$}, '/blog/2009/08/17/seo-weekly-round-up-3/'
  r301 %r{^/2009/08/24/the-best-ppt-about-eye-candy/?$}, '/blog/2009/08/25/the-best-ppt-about-eye-candy/'
  r301 %r{^/2009/08/24/weekly-seo-round-up-6/?$}, '/blog/2009/08/25/weekly-seo-round-up-6/'
  r301 %r{^/2009/08/26/great-little-overview-of-rackspace-cloud-offering/?$}, '/blog/2009/08/27/great-little-overview-of-rackspace-cloud-offering/'
  r301 %r{^/2009/08/27/snow-leopard/?$}, '/blog/2009/08/28/snow-leopard/'
  r301 %r{^/2009/09/07/social-media?$}, '/blog/2009/09/08/social-media-in-the-office/'
  r301 %r{^/2009/09/07/social-media-in-the-office/?$}, '/blog/2009/09/08/social-media-in-the-office/'
  r301 %r{^/2009/09/07/video-from-jeff-bezos-about-amazon-and-zappos/?$}, '/blog/2009/09/07/video-from-jeff-bezos-about-amazon-and-zappos/'
  r301 %r{^/2009/09/10/warehouse-hunt/?$}, '/blog/2009/09/10/warehouse-hunt/'
  r301 %r{^/2010/02/16/penny-shooter-business-card/?$}, '/blog/2010/02/16/penny-shooter-business-card/'
  r301 %r{^/2010/02/17/warehouse-built-back-in-marketing/?$}, '/blog/2010/02/17/warehouse-built-back-in-marketing/'
  r301 %r{^/2010/02/19/shopping-just-wont-be-the-same/?$}, '/blog/2010/02/19/shopping-just-wont-be-the-same/'
  r301 %r{^/2010/06/27/couple-of-great-articles/?$}, '/blog/2010/06/27/couple-of-great-articles/'
  r301 %r{^/2010/06/30/the-stats-about-pharmaceutical-companies/?$}, '/blog/2010/07/01/the-stats-about-pharmaceutical-companies/'
  r301 %r{^/2010/09/13/enabling-ssl-in-proftpd/?$}, '/blog/2010/09/14/enabling-ssl-in-proftpd/'
  r301 %r{^/2010/09/24/where-good-ideas-come-from-by-steven-johnson/?$}, '/blog/2010/09/24/where-good-ideas-come-from-by-steven-johnson/'
  r301 %r{^/2010/10/07/a-new-week/?$}, '/blog/2010/10/07/a-new-week/'
  r301 %r{^/2010/10/10/how-to-run-banks/?$}, '/blog/2010/10/10/how-to-run-banks/'
  r301 %r{^/2010/10/19/editing-your-hosts-file-on-a-mac/?$}, '/blog/2010/10/20/editing-your-hosts-file-on-a-mac/'
  r301 %r{^/2010/12/02/making-the-chevrolet-volt-in-1m-55s/?$}, '/blog/2010/12/03/making-the-chevrolet-volt-in-1m-55s/'
  r301 %r{^/2011/05/28/world-petrol-prices/?$}, '/blog/2011/05/28/world-petrol-prices/'
  r301 %r{^/2011/05/30/amazon-the-hidden-empire/?$}, '/blog/2011/05/31/amazon-the-hidden-empire/'
  r301 %r{^/2011/05/31/moving-to-ubuntu-saying-goodbye-to-centosredhat/?$}, '/blog/2011/05/31/moving-to-ubuntu-saying-goodbye-to-centosredhat/'
  r301 %r{^/2011/06/03/the-rise-and-fall-and-rise-of-java/?$}, '/blog/2011/06/03/the-rise-and-fall-and-rise-of-java/'
  r301 %r{^/2011/06/03/windows-8-is-a-mac-copy/?$}, '/blog/2011/06/03/windows-8-is-a-mac-copy/'
  r301 %r{^/2011/06/11/the-mobile-movement-understanding-smartphone-consumers/?$}, '/blog/2011/06/11/the-mobile-movement-understanding-smartphone-consumers/'
  r301 %r{^/2011/06/20/netflix-velocity-conference-2011/?$}, '/blog/2011/06/20/netflix-velocity-conference-2011/'
  r301 %r{^/2011/07/06/data-driven-startups/?$}, '/blog/2011/07/06/data-driven-startups/'
  r301 %r{^/2011/07/06/startup-metrics-for-pirates/?$}, '/blog/2011/07/06/startup-metrics-for-pirates/'
  r301 %r{^/2011/07/25/crappy-internet/?$}, '/blog/2011/07/25/crappy-internet/'
  r301 %r{^/2011/09/21/amazing-himalayas-photos/?$}, '/blog/2011/09/21/amazing-himalayas-photos/'
  r301 %r{^/2011/09/22/small-script-to-remove-a-list-of-directories/?$}, '/blog/2011/09/23/small-script-to-remove-a-list-of-directories/'
  r301 %r{^/2011/11/12/internet-speed/?$}, '/blog/2011/11/12/internet-speed/'
  r301 %r{^/about-me/?$}, '/about/'
  r301 %r{^/category/business/?$}, '/blog/categories/business/'
  r301 %r{^/category/china/?$}, '/blog/categories/china/'
  r301 %r{^/category/cloud/?$}, '/blog/categories/cloud/'
  r301 %r{^/category/companies/?$}, '/blog/categories/companies/'
  r301 %r{^/category/ecommerce/?$}, '/blog/categories/ecommerce/'
  r301 %r{^/category/formual1/?$}, '/blog/categories/formual-1/'
  r301 %r{^/category/java/?$}, '/blog/categories/java/'
  r301 %r{^/category/linux-apple/?$}, '/blog/categories/linux-apple/'
  r301 %r{^/category/marketing/?$}, '/blog/categories/marketing/'
  r301 %r{^/category/news/?$}, '/blog/categories/news/'
  r301 %r{^/category/open-source/?$}, '/blog/categories/open-source/'
  r301 %r{^/category/random-stuff/?$}, '/blog/categories/random-stuff/'
  r301 %r{^/category/seo/?$}, '/blog/categories/seo/'
  r301 %r{^/category/twitter/?$}, '/blog/categories/twitter/'
  r301 %r{^/category/work/?$}, '/blog/categories/work/'
  r301 %r{^/my-music/?$}, '/about/'
  r301 %r{^/wp-content/uploads/2011/07/Equinix_Submarine_TGMap_MTS_15.pdf?$}, '/images/Equinix_Submarine_TGMap_MTS_15.pdf'
  r301 %r{^/feed/?$}, 'http://feeds.samhamilton.co.uk/samhamilton-co-uk'
end

class SinatraStaticServer < Sinatra::Base  

  get(/.+/) do
    send_sinatra_file(request.path) {404}
  end

  not_found do
    send_sinatra_file('404.html') {"Sorry, I cannot find #{request.path}"}
  end

  def send_sinatra_file(path, &missing_file_block)
    file_path = File.join(File.dirname(__FILE__), 'public',  path)
    file_path = File.join(file_path, 'index.html') unless file_path =~ /\.[a-z]+$/i  
    File.exist?(file_path) ? send_file(file_path) : missing_file_block.call
  end

end

run SinatraStaticServer